# Copyright 2025 Google LLC
# SPDX-License-Identifier: Apache-2.0
#
# Generated headers for WasmEdge

package(default_visibility = ["//visibility:public"])

# Generate api/wasmedge/version.h from template
genrule(
    name = "generate_api_version_header",
    srcs = ["api/wasmedge/version.h.in"],
    outs = ["api/wasmedge/version.h"],
    cmd = """
        sed -e 's/$${CPACK_PACKAGE_VERSION}/0.16.1/g' \\
            -e 's/$${WASMEDGE_VERSION_MAJOR}/0/g' \\
            -e 's/$${WASMEDGE_VERSION_MINOR}/16/g' \\
            -e 's/$${WASMEDGE_VERSION_PATCH}/1/g' \\
            -e 's/$${WASMEDGE_API_VERSION}/4/g' \\
            $(location api/wasmedge/version.h.in) > $@
    """,
)

# Generate common/config.h from template
genrule(
    name = "generate_config_header",
    srcs = ["common/config.h.in"],
    outs = ["common/config.h"],
    cmd = """
        cat > $@ << 'EOF'
// SPDX-License-Identifier: Apache-2.0
// SPDX-FileCopyrightText: 2019-2024 Second State INC
// Generated by Bazel build

#pragma once

#include <string_view>

namespace WasmEdge {

using namespace std::literals::string_view_literals;

static inline constexpr std::string_view kCacheRoot [[maybe_unused]] = "/var/cache/wasmedge"sv;

#define HAVE_MMAP 1
#define HAVE_PWD_H 1

} // namespace WasmEdge
EOF
    """,
)

# Generate common/version.h from template
genrule(
    name = "generate_common_version_header",
    srcs = ["common/version.h.in"],
    outs = ["common/version.h"],
    cmd = """
        cat > $@ << 'EOF'
// SPDX-License-Identifier: Apache-2.0
// SPDX-FileCopyrightText: 2019-2024 Second State INC
// Generated by Bazel build

#pragma once

#include <string_view>

namespace WasmEdge {

using namespace std::literals::string_view_literals;

static inline std::string_view kVersionString [[maybe_unused]] = "0.16.1"sv;
static inline std::string_view kGlobalPluginDir [[maybe_unused]] = "/usr/local/lib/wasmedge"sv;
static inline constexpr const uint32_t kPluginCurrentAPIVersion [[maybe_unused]] = 4;

} // namespace WasmEdge
EOF
    """,
)

# Copy enum headers from common/ to api/wasmedge/ as CMake does
genrule(
    name = "copy_enum_headers",
    srcs = [
        "common/enum.inc",
        "common/enum_configure.h",
        "common/enum_errcode.h",
        "common/enum_types.h",
    ],
    outs = [
        "api/wasmedge/enum.inc",
        "api/wasmedge/enum_configure.h",
        "api/wasmedge/enum_errcode.h",
        "api/wasmedge/enum_types.h",
    ],
    cmd = """
        cp $(location common/enum.inc) $(location api/wasmedge/enum.inc)
        cp $(location common/enum_configure.h) $(location api/wasmedge/enum_configure.h)
        cp $(location common/enum_errcode.h) $(location api/wasmedge/enum_errcode.h)
        cp $(location common/enum_types.h) $(location api/wasmedge/enum_types.h)
    """,
)

# Export api headers for lib/api to use
filegroup(
    name = "api_headers",
    srcs = glob([
        "api/*.h",
        "api/wasmedge/*.h",
    ]),
)

# Export headers for each library component
filegroup(
    name = "common_headers",
    srcs = glob([
        "common/*.h",
        "common/*.hpp",
        "common/*.inc",
        "experimental/*.hpp",
    ]),
)

filegroup(
    name = "ast_headers",
    srcs = glob(["ast/*.h"]),
)

filegroup(
    name = "runtime_headers",
    srcs = glob(["runtime/*.h"]),
)

filegroup(
    name = "system_headers",
    srcs = glob(["system/*.h"]),
)

filegroup(
    name = "po_headers",
    srcs = glob(["po/*.h"]),
)

filegroup(
    name = "loader_headers",
    srcs = glob(["loader/*.h"]),
)

filegroup(
    name = "validator_headers",
    srcs = glob(["validator/*.h"]),
)

filegroup(
    name = "executor_headers",
    srcs = glob(["executor/*.h"]),
)

filegroup(
    name = "host_headers",
    srcs = glob(["host/*.h"]),
)

filegroup(
    name = "plugin_headers",
    srcs = glob(["plugin/*.h"]),
)

filegroup(
    name = "vm_headers",
    srcs = glob(["vm/*.h"]),
)

filegroup(
    name = "aot_headers",
    srcs = glob(["aot/*.h"]),
)
