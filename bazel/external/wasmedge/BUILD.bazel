# Copyright 2025 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# ==============================================================================
# WasmEdge Runtime - Comprehensive Single-File Build Configuration
# ==============================================================================
#
# This BUILD file provides a complete build configuration for the WasmEdge
# WebAssembly runtime. It includes all necessary components:
#
# - Generated headers (version.h, config.h, enum headers)
# - Core libraries (common, ast, runtime, system)
# - Loader and validator components
# - Executor and VM components
# - WASI host module with platform-specific implementations
# - Plugin system
# - Public API layer
#
# Main targets:
#   :wasmedge_lib - Complete WasmEdge library (recommended)
#   :wasmedge_interpreter - Interpreter-only build (no AOT/LLVM)
#
# Based on: https://github.com/mmorel-35/WasmEdge/pull/1

load("@rules_cc//cc:defs.bzl", "cc_library")

licenses(["notice"])  # Apache 2.0

package(default_visibility = ["//visibility:public"])

# ==============================================================================
# Generated Headers
# ==============================================================================
# These genrules create necessary header files from templates that would
# normally be generated by CMake during the build process.

# Generate api/wasmedge/version.h from template
# Contains version information used by the public API
genrule(
    name = "generate_version_header",
    srcs = ["include/api/wasmedge/version.h.in"],
    outs = ["include/api/wasmedge/version.h"],
    cmd = """
        sed -e 's/$${CPACK_PACKAGE_VERSION}/0.16.1/g' \\
            -e 's/$${WASMEDGE_VERSION_MAJOR}/0/g' \\
            -e 's/$${WASMEDGE_VERSION_MINOR}/16/g' \\
            -e 's/$${WASMEDGE_VERSION_PATCH}/1/g' \\
            -e 's/$${WASMEDGE_API_VERSION}/4/g' \\
            $(location include/api/wasmedge/version.h.in) > $@
    """,
)

# Generate common/config.h from template
# Contains platform-specific configuration and feature flags
genrule(
    name = "generate_config_header",
    srcs = ["include/common/config.h.in"],
    outs = ["include/common/config.h"],
    cmd = """
        cat > $@ << 'INNER_EOF'
// SPDX-License-Identifier: Apache-2.0
// SPDX-FileCopyrightText: 2019-2024 Second State INC
// Generated by Bazel build

#pragma once

#include <string_view>

namespace WasmEdge {

using namespace std::literals::string_view_literals;

static inline constexpr std::string_view kCacheRoot [[maybe_unused]] = "/var/cache/wasmedge"sv;

#define HAVE_MMAP 1
#define HAVE_PWD_H 1

} // namespace WasmEdge
INNER_EOF
    """,
)

# Generate common/version.h from template
# Contains version strings and plugin API version information
genrule(
    name = "generate_common_version_header",
    srcs = ["include/common/version.h.in"],
    outs = ["include/common/version.h"],
    cmd = """
        cat > $@ << 'INNER_EOF'
// SPDX-License-Identifier: Apache-2.0
// SPDX-FileCopyrightText: 2019-2024 Second State INC
// Generated by Bazel build

#pragma once

#include <string_view>

namespace WasmEdge {

using namespace std::literals::string_view_literals;

static inline std::string_view kVersionString [[maybe_unused]] = "0.16.1"sv;
static inline std::string_view kGlobalPluginDir [[maybe_unused]] = "/usr/local/lib/wasmedge"sv;
static inline constexpr const uint32_t kPluginCurrentAPIVersion [[maybe_unused]] = 4;

} // namespace WasmEdge
INNER_EOF
    """,
)

# Copy enum headers from common/ to api/wasmedge/
# The public API includes these as <wasmedge/enum_*.h>, but they're defined
# in the common/ directory. This matches CMake's install behavior.
genrule(
    name = "copy_enum_headers",
    srcs = [
        "include/common/enum.inc",
        "include/common/enum_configure.h",
        "include/common/enum_errcode.h",
        "include/common/enum_types.h",
    ],
    outs = [
        "include/api/wasmedge/enum.inc",
        "include/api/wasmedge/enum_configure.h",
        "include/api/wasmedge/enum_errcode.h",
        "include/api/wasmedge/enum_types.h",
    ],
    cmd = """
        cp $(location include/common/enum.inc) $(location include/api/wasmedge/enum.inc)
        cp $(location include/common/enum_configure.h) $(location include/api/wasmedge/enum_configure.h)
        cp $(location include/common/enum_errcode.h) $(location include/api/wasmedge/enum_errcode.h)
        cp $(location include/common/enum_types.h) $(location include/api/wasmedge/enum_types.h)
    """,
)

# ==============================================================================
# Core Libraries
# ==============================================================================
# These libraries provide the foundational data structures, utilities, and
# abstractions used throughout WasmEdge.

# Common library - Shared utilities, error handling, logging
# Provides fundamental types, error information, hashing, and logging
# infrastructure used by all other components.
cc_library(
    name = "common",
    srcs = [
        "lib/common/errinfo.cpp",
        "lib/common/hash.cpp",
        "lib/common/hexstr.cpp",
        "lib/common/spdlog.cpp",
    ],
    hdrs = glob([
        "include/common/*.h",
        "include/common/*.hpp",
        "include/common/*.inc",
        "include/experimental/*.hpp",
    ]) + [
        ":generate_config_header",
        ":generate_common_version_header",
    ],
    includes = ["include"],
    deps = [
        "@spdlog",
    ],
)

# AST (Abstract Syntax Tree) library - Header-only
# Defines data structures representing WebAssembly modules, functions,
# instructions, and types after parsing.
cc_library(
    name = "ast",
    hdrs = glob([
        "include/ast/*.h",
        "include/ast/**/*.h",
    ]),
    includes = ["include"],
    deps = [
        ":common",
    ],
)

# Runtime library - Header-only
# Defines runtime data structures like module instances, function instances,
# memory, tables, and globals.
cc_library(
    name = "runtime",
    hdrs = glob([
        "include/runtime/*.h",
        "include/runtime/**/*.h",
    ]),
    includes = ["include"],
    deps = [
        ":ast",
        ":common",
    ],
)

# System library - Platform abstraction layer
# Provides platform-specific functionality like memory allocation, fault
# handling, memory mapping, path utilities, and stack traces.
cc_library(
    name = "system",
    srcs = [
        "lib/system/allocator.cpp",
        "lib/system/fault.cpp",
        "lib/system/mmap.cpp",
        "lib/system/path.cpp",
        "lib/system/stacktrace.cpp",
    ],
    hdrs = glob(["include/system/*.h"]),
    includes = ["include"],
    linkopts = select({
        "@platforms//os:windows": ["-ldbghelp"],
        "//conditions:default": [],
    }),
    deps = [
        ":common",
        ":runtime",
    ],
)

# Program Options library
# Command-line argument parsing and configuration management.
cc_library(
    name = "po",
    srcs = glob(["lib/po/*.cpp"]),
    hdrs = glob(["include/po/*.h"]),
    includes = ["include"],
    deps = [
        ":common",
        ":system",
    ],
)

# ==============================================================================
# WebAssembly Core Components
# ==============================================================================
# These libraries implement the core WebAssembly specification: loading,
# validation, and execution.

# Loader library - WebAssembly module parsing
# Responsible for loading and parsing WebAssembly binary and text formats,
# including file management and deserialization into AST structures.
cc_library(
    name = "loader",
    srcs = glob([
        "lib/loader/*.cpp",
        "lib/loader/filemgr/*.cpp",
    ]),
    hdrs = glob([
        "include/loader/*.h",
        "include/loader/filemgr/*.h",
        "include/aot/*.h",
    ]),
    includes = ["include"],
    deps = [
        ":ast",
        ":common",
        ":system",
        "@simdjson",
    ],
)

# Validator library - WebAssembly validation
# Validates WebAssembly modules according to the specification, ensuring
# type safety and structural correctness before execution.
cc_library(
    name = "validator",
    srcs = glob(["lib/validator/*.cpp"]),
    hdrs = glob(["include/validator/*.h"]),
    includes = ["include"],
    deps = [
        ":ast",
        ":common",
    ],
)

# Executor library - WebAssembly execution engine
# The core interpreter that executes WebAssembly instructions. Handles
# the execution stack, control flow, and instruction dispatch.
cc_library(
    name = "executor",
    srcs = glob(["lib/executor/**/*.cpp"]),
    hdrs = glob([
        "include/executor/*.h",
        "include/executor/engine/*.ipp",
    ]),
    includes = ["include"],
    deps = [
        ":ast",
        ":common",
        ":loader",
        ":runtime",
        ":system",
    ],
)

# ==============================================================================
# Host Modules and Extensions
# ==============================================================================
# These libraries provide host functionality and extensions to the core
# WebAssembly specification.

# WASI (WebAssembly System Interface) host module
# Implements WASI functionality for file I/O, environment access, and
# system calls. Includes platform-specific implementations for Linux,
# macOS, and Windows.
cc_library(
    name = "host_wasi",
    srcs = glob(["lib/host/wasi/*.cpp"]) + select({
        "@platforms//os:linux": glob(["lib/host/wasi/linux/*.cpp"]),
        "@platforms//os:macos": glob(["lib/host/wasi/darwin/*.cpp"]),
        "@platforms//os:windows": glob(["lib/host/wasi/win/*.cpp"]),
        "//conditions:default": [],
    }),
    hdrs = glob(["include/host/wasi/*.h"]) + [
        "thirdparty/wasi/api.hpp",
    ],
    includes = [
        "include",
        "thirdparty",
    ],
    deps = [
        ":common",
        ":executor",
        ":system",
    ],
)

# Plugin system - Dynamic extension loading
# Provides infrastructure for loading and managing WasmEdge plugins,
# enabling runtime extensibility with custom host functions.
cc_library(
    name = "plugin",
    srcs = glob(["lib/plugin/*.cpp"]),
    hdrs = glob([
        "include/plugin/*.h",
        "include/plugin/wasi_logging/*.h",
        "include/api/wasmedge/*.h",
    ]) + [
        ":copy_enum_headers",
        ":generate_version_header",
    ],
    includes = [
        "include",
        "include/api",
    ],
    deps = [
        ":common",
        ":loader",
        ":po",
    ],
)

# WASI Logging plugin
# Implements the WASI logging proposal for structured logging from
# WebAssembly modules.
cc_library(
    name = "plugin_wasi_logging",
    srcs = glob(["lib/plugin/wasi_logging/*.cpp"]),
    hdrs = glob(["include/plugin/wasi_logging/*.h"]),
    includes = ["include"],
    deps = [
        ":common",
        ":plugin",
    ],
)

# ==============================================================================
# VM and Driver Components
# ==============================================================================
# High-level components that orchestrate the loader, validator, and executor.

# VM library - Virtual machine orchestration
# Coordinates the loading, validation, instantiation, and execution of
# WebAssembly modules. Manages the runtime environment and host modules.
cc_library(
    name = "vm",
    srcs = glob(["lib/vm/*.cpp"]),
    hdrs = glob(["include/vm/*.h"]),
    includes = ["include"],
    deps = [
        ":common",
        ":executor",
        ":host_wasi",
        ":loader",
        ":plugin",
        ":validator",
    ],
)

# Driver library - High-level execution driver (minimal build without AOT/LLVM)
# Provides command-line interface and high-level APIs for running
# WebAssembly modules with various configurations.
# Note: Excludes AOT compiler and wasiNN RPC server which require LLVM.
cc_library(
    name = "driver",
    srcs = [
        "lib/driver/fuzzPO.cpp",
        "lib/driver/fuzzTool.cpp",
        "lib/driver/runtimeTool.cpp",
        "lib/driver/uniTool.cpp",
    ],
    hdrs = glob(["include/driver/*.h"]),
    includes = ["include"],
    deps = [
        ":common",
        ":po",
        ":vm",
    ],
)

# ==============================================================================
# Public API
# ==============================================================================
# The public C API that applications use to interact with WasmEdge.

# API library - Public C API implementation
# Provides the stable C API for embedding WasmEdge in applications.
# Includes the main wasmedge.h header and supporting enum definitions.
cc_library(
    name = "api_wasmedge",
    srcs = ["lib/api/wasmedge.cpp"],
    hdrs = glob([
        "include/api/wasmedge/*.h",
        "include/api/*.h",
    ]) + [
        ":copy_enum_headers",
        ":generate_version_header",
    ],
    includes = [
        "include",
        "include/api",
    ],
    deps = [
        ":common",
        ":driver",
        ":vm",
    ],
)

# ==============================================================================
# Main Library Targets
# ==============================================================================
# These are the primary targets that external projects should depend on.

# Complete WasmEdge library (recommended)
# This is the main target that provides the full WasmEdge functionality
# including the public API, VM, all host modules, and plugins.
cc_library(
    name = "wasmedge_lib",
    deps = [
        ":api_wasmedge",
    ],
)

# Interpreter-only build (no AOT/LLVM)
# A lighter-weight build that includes only the core interpreter components
# without the full driver and API layer. Useful for minimal embeddings.
cc_library(
    name = "wasmedge_interpreter",
    deps = [
        ":common",
        ":executor",
        ":loader",
        ":validator",
        ":vm",
    ],
)
