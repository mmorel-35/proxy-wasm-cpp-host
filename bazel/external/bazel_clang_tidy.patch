# 1. Treat .h files as C++ headers.
# 2. Use hermetic LLVM toolchain's clang-tidy for better compatibility.

diff --git a/clang_tidy/BUILD b/clang_tidy/BUILD
index 9b6a61e..2b1e5b6 100644
--- a/clang_tidy/BUILD
+++ b/clang_tidy/BUILD
@@ -1,7 +1,10 @@
 sh_binary(
     name = "clang_tidy",
     srcs = ["run_clang_tidy.sh"],
-    data = ["//:clang_tidy_config"],
+    data = [
+        "//:clang_tidy_config",
+        "@llvm_toolchain_llvm//:bin/clang-tidy",
+    ],
     tags = ["no-sandbox"],
     visibility = ["//visibility:public"],
 )
diff --git a/clang_tidy/clang_tidy.bzl b/clang_tidy/clang_tidy.bzl
index 3a5ed07..5db5c6c 100644
--- a/clang_tidy/clang_tidy.bzl
+++ b/clang_tidy/clang_tidy.bzl
@@ -16,6 +16,9 @@ def _run_tidy(ctx, exe, flags, compilation_context, infile, discriminator):
     # add source to check
     args.add(infile.path)
 
+    # treat .h files as C++ headers
+    args.add("--extra-arg-before=-xc++")
+
     # start args passed to the compiler
     args.add("--")
 
diff --git a/clang_tidy/run_clang_tidy.sh b/clang_tidy/run_clang_tidy.sh
index 92fbf09..e8cd2da 100644
--- a/clang_tidy/run_clang_tidy.sh
+++ b/clang_tidy/run_clang_tidy.sh
@@ -1,3 +1,4 @@
+#!/bin/bash
 set -ue
 
 # Usage: run_clang_tidy <OUTPUT> [ARGS...]
@@ -11,4 +12,21 @@ OUTPUT=$1
 touch $OUTPUT
 truncate -s 0 $OUTPUT
 
-clang-tidy "$@"
+# Use hermetic LLVM toolchain's clang-tidy from runfiles if available
+# This ensures compatibility with the hermetic libc++ used in compilation
+RUNFILES_DIR="${RUNFILES_DIR:-}"
+if [ -z "$RUNFILES_DIR" ]; then
+    RUNFILES_DIR="$(dirname "$0")/.runfiles"
+fi
+
+HERMETIC_CLANG_TIDY="$RUNFILES_DIR/llvm_toolchain_llvm/bin/clang-tidy"
+if [ -f "$HERMETIC_CLANG_TIDY" ]; then
+    # Add include paths for hermetic libc++ headers
+    LLVM_INCLUDE="$RUNFILES_DIR/llvm_toolchain_llvm/include/c++/v1"
+    if [ -d "$LLVM_INCLUDE" ]; then
+        exec "$HERMETIC_CLANG_TIDY" "$1" --extra-arg=-isystem"$LLVM_INCLUDE" "${@:2}"
+    else
+        exec "$HERMETIC_CLANG_TIDY" "$@"
+    fi
+else
+    exec clang-tidy "$@"
+fi

