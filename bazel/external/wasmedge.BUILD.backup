# Copyright 2025 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# Native Bazel BUILD file for WasmEdge runtime
# Based on https://github.com/mmorel-35/WasmEdge/pull/1

load("@rules_cc//cc:defs.bzl", "cc_library")

licenses(["notice"])  # Apache 2

package(default_visibility = ["//visibility:public"])

# Copy enum headers from common/ to api/wasmedge/ as CMake does
# This is needed because API headers include wasmedge/enum_*.h
genrule(
    name = "copy_enum_headers",
    srcs = [
        "include/common/enum.inc",
        "include/common/enum_configure.h",
        "include/common/enum_errcode.h",
        "include/common/enum_types.h",
    ],
    outs = [
        "include/api/wasmedge/enum.inc",
        "include/api/wasmedge/enum_configure.h",
        "include/api/wasmedge/enum_errcode.h",
        "include/api/wasmedge/enum_types.h",
    ],
    cmd = """
        cp $(location include/common/enum.inc) $(location include/api/wasmedge/enum.inc)
        cp $(location include/common/enum_configure.h) $(location include/api/wasmedge/enum_configure.h)
        cp $(location include/common/enum_errcode.h) $(location include/api/wasmedge/enum_errcode.h)
        cp $(location include/common/enum_types.h) $(location include/api/wasmedge/enum_types.h)
    """,
)

# Generate version.h from template
genrule(
    name = "generate_version_header",
    srcs = ["include/api/wasmedge/version.h.in"],
    outs = ["include/api/wasmedge/version.h"],
    cmd = """
        sed -e 's/$${CPACK_PACKAGE_VERSION}/0.16.1/g' \
            -e 's/$${WASMEDGE_VERSION_MAJOR}/0/g' \
            -e 's/$${WASMEDGE_VERSION_MINOR}/16/g' \
            -e 's/$${WASMEDGE_VERSION_PATCH}/1/g' \
            -e 's/$${WASMEDGE_API_VERSION}/4/g' \
            $(location include/api/wasmedge/version.h.in) > $@
    """,
)

# Generate config.h from template
genrule(
    name = "generate_config_header",
    srcs = ["include/common/config.h.in"],
    outs = ["include/common/config.h"],
    cmd = """
        cat > $@ << 'EOF'
// SPDX-License-Identifier: Apache-2.0
// SPDX-FileCopyrightText: 2019-2024 Second State INC
// Generated by Bazel build

#pragma once

#include <string_view>

namespace WasmEdge {

using namespace std::literals::string_view_literals;

static inline constexpr std::string_view kCacheRoot [[maybe_unused]] = "/var/cache/wasmedge"sv;

#define HAVE_MMAP 1
#define HAVE_PWD_H 1

} // namespace WasmEdge
EOF
    """,
)

# Generate common/version.h from template
genrule(
    name = "generate_common_version_header",
    srcs = ["include/common/version.h.in"],
    outs = ["include/common/version.h"],
    cmd = """
        cat > $@ << 'EOF'
// SPDX-License-Identifier: Apache-2.0
// SPDX-FileCopyrightText: 2019-2024 Second State INC
// Generated by Bazel build

#pragma once

#include <string_view>

namespace WasmEdge {

using namespace std::literals::string_view_literals;

static inline std::string_view kVersionString [[maybe_unused]] = "0.16.1"sv;
static inline std::string_view kGlobalPluginDir [[maybe_unused]] = "/usr/local/lib/wasmedge"sv;
static inline constexpr const uint32_t kPluginCurrentAPIVersion [[maybe_unused]] = 4;

} // namespace WasmEdge
EOF
    """,
)

# Common library
cc_library(
    name = "common",
    srcs = [
        "lib/common/errinfo.cpp",
        "lib/common/hash.cpp",
        "lib/common/hexstr.cpp",
        "lib/common/spdlog.cpp",
    ],
    hdrs = glob([
        "include/common/*.h",
        "include/common/*.hpp",
        "include/common/*.inc",  # Include .inc header files
        "include/experimental/*.hpp",  # Include experimental headers
    ]) + [
        ":generate_config_header",  # Generated config.h
        ":generate_common_version_header",  # Generated version.h
    ],
    includes = ["include"],
    deps = [
        "@spdlog",
    ],
)

# AST (Abstract Syntax Tree) - header-only library
cc_library(
    name = "ast",
    hdrs = glob([
        "include/ast/*.h",
        "include/ast/**/*.h",
    ]),
    includes = ["include"],
    deps = [
        ":common",
    ],
)

# Runtime - header-only library
cc_library(
    name = "runtime",
    hdrs = glob([
        "include/runtime/*.h",
        "include/runtime/**/*.h",
    ]),
    includes = ["include"],
    deps = [
        ":ast",
        ":common",
    ],
)

# System library
cc_library(
    name = "system",
    srcs = [
        "lib/system/allocator.cpp",
        "lib/system/fault.cpp",
        "lib/system/mmap.cpp",
        "lib/system/path.cpp",
        "lib/system/stacktrace.cpp",
    ],
    hdrs = glob(["include/system/*.h"]),
    includes = ["include"],
    linkopts = select({
        "@platforms//os:windows": ["-ldbghelp"],
        "//conditions:default": [],
    }),
    deps = [
        ":common",
        ":runtime",
    ],
)

# Program Options library
cc_library(
    name = "po",
    srcs = glob(["lib/po/*.cpp"]),
    hdrs = glob(["include/po/*.h"]),
    includes = ["include"],
    deps = [
        ":common",
        ":system",
    ],
)

# Loader library  
cc_library(
    name = "loader",
    srcs = glob([
        "lib/loader/*.cpp",
        "lib/loader/filemgr/*.cpp",
    ]),
    hdrs = glob([
        "include/loader/*.h",
        "include/loader/filemgr/*.h",
        "include/aot/*.h",  # Include AOT headers for version info
    ]),
    includes = ["include"],
    deps = [
        ":ast",
        ":common",
        ":system",
        "@simdjson",
    ],
)

# Validator library
cc_library(
    name = "validator",
    srcs = glob(["lib/validator/*.cpp"]),
    hdrs = glob(["include/validator/*.h"]),
    includes = ["include"],
    deps = [
        ":ast",
        ":common",
    ],
)

# Executor library
cc_library(
    name = "executor",
    srcs = glob(["lib/executor/**/*.cpp"]),
    hdrs = glob(["include/executor/*.h"]),
    includes = ["include"],
    deps = [
        ":ast",
        ":common",
        ":runtime",
        ":system",
    ],
)

# WASI host module
cc_library(
    name = "host_wasi",
    srcs = glob(["lib/host/wasi/*.cpp"]) + select({
        "@platforms//os:linux": glob(["lib/host/wasi/linux/*.cpp"]),
        "@platforms//os:macos": glob(["lib/host/wasi/darwin/*.cpp"]),
        "@platforms//os:windows": glob(["lib/host/wasi/win/*.cpp"]),
        "//conditions:default": [],
    }),
    hdrs = glob(["include/host/wasi/*.h"]),
    includes = ["include"],
    deps = [
        ":common",
        ":executor",
        ":system",
    ],
)

# Plugin library
cc_library(
    name = "plugin",
    srcs = glob(["lib/plugin/*.cpp"]),
    hdrs = glob(["include/plugin/*.h"]),
    includes = ["include"],
    deps = [
        ":common",
        ":loader",
    ],
)

# WASI Logging plugin
cc_library(
    name = "plugin_wasi_logging",
    srcs = glob(["lib/plugin/wasi_logging/*.cpp"]),
    hdrs = glob(["include/plugin/wasi_logging/*.h"]),
    includes = ["include"],
    deps = [
        ":common",
        ":plugin",
    ],
)

# VM library
cc_library(
    name = "vm",
    srcs = glob(["lib/vm/*.cpp"]),
    hdrs = glob(["include/vm/*.h"]),
    includes = ["include"],
    deps = [
        ":common",
        ":executor",
        ":host_wasi",
        ":loader",
        ":plugin",
        ":validator",
    ],
)

# Driver library
cc_library(
    name = "driver",
    srcs = glob(["lib/driver/*.cpp"]),
    hdrs = glob(["include/driver/*.h"]),
    includes = ["include"],
    deps = [
        ":common",
        ":po",
        ":vm",
    ],
)

# API library (main entry point)
cc_library(
    name = "wasmedge_lib",
    srcs = ["lib/api/wasmedge.cpp"],
    hdrs = glob([
        "include/api/wasmedge/*.h",
        "include/api/*.h",  # Include top-level API headers
    ]) + [
        # Generated enum headers copied from common/
        ":copy_enum_headers",
        # Generated version header
        ":generate_version_header",
    ],
    includes = [
        "include",
        "include/api",
    ],
    deps = [
        ":common",  # Add common dependency for enum headers
        ":driver",
        ":vm",
    ],
)
